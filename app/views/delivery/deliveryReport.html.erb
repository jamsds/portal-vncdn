<div class="portal__main-heading">
  <a href="<%= url_for(:back) %>" class="btn btn-default btn-sm ml-2">
    <span class="back_ic">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="12" viewBox="0 0 18 12">
        <path d="M353.6,392.8v2H339.4l3.6,3.6-1.4,1.4-6-6,6-6,1.4,1.4-3.6,3.6Z" transform="translate(-335.6 -387.8)" fill="#333333"/>
      </svg>
    </span>
    <span>
      Back
    </span>
  </a>
</div>
<div class="portal__main-left expanded">
  <div class="panel">
    <div class="panel__list main">
      <div class="main__options-list">
        <a href="/cdn/<%= params[:propertyId] %>/<%= params[:dtype] %>" class="main__options-list-item clearfix">
          <div class="main__options-list-item-ic">
            <div class="was_ic">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="17" viewBox="0 0 22 17"><path d="M242.8,1047a2.051,2.051,0,0,1,2,2v13a2.051,2.051,0,0,1-2,2h-18a2.051,2.051,0,0,1-2-2v-13a2.051,2.051,0,0,1,2-2Zm0,15v-13h-9v13Zm-8.1-9.5h7v1.5h-7Zm0,2.5h7v1.5h-7Zm0,2.5h7v1.5h-7Z" transform="translate(-222.8 -1047)" fill="#fff"/></svg>
            </div>
          </div>
          <div class="main__options-list-item-info">
            <h6>Detail</h6>
            <small>Detail information this service</small>
          </div>
          <div class="main__options-list-item-arrow"></div>
        </a>
        <a href="/cdn/<%= params[:propertyId] %>/<%= params[:dtype] %>/edit" class="main__options-list-item clearfix">
          <div class="main__options-list-item-ic">
            <div class="was_ic">
              <svg xmlns="http://www.w3.org/2000/svg" width="19.618" height="20" viewBox="0 0 19.618 20"><path d="M56.4,1160.4l2.1,1.6a.592.592,0,0,1,.1.7l-2,3.5a.445.445,0,0,1-.6.2l-2.5-1a8.152,8.152,0,0,1-1.7,1l-.4,2.6c-.1.3-.2.4-.5.4h-4a.51.51,0,0,1-.5-.4l-.4-2.6a5.852,5.852,0,0,1-1.7-1l-2.5,1a.445.445,0,0,1-.6-.2l-2-3.5a.483.483,0,0,1,.1-.7l2.1-1.6v-2l-2.1-1.6a.592.592,0,0,1-.1-.7l2-3.5a.445.445,0,0,1,.6-.2l2.5,1a8.152,8.152,0,0,1,1.7-1l.4-2.6c.1-.3.2-.4.5-.4h4a.51.51,0,0,1,.5.4l.4,2.6a5.852,5.852,0,0,1,1.7,1l2.5-1a.445.445,0,0,1,.6.2l2,3.5a.483.483,0,0,1-.1.7l-2.1,1.6v2Zm-9.9,1.5a3.625,3.625,0,1,0-1-2.5A3.317,3.317,0,0,0,46.5,1161.9Z" transform="translate(-39.091 -1149.4)"/></svg>
            </div>
          </div>
          <div class="main__options-list-item-info">
            <h6>Edit</h6>
            <small>Edit this service</small>
          </div>
          <div class="main__options-list-item-arrow"></div>
        </a>
        <a href="/cdn/<%= params[:propertyId] %>/<%= params[:dtype] %>/policies/a" class="main__options-list-item clearfix">
          <div class="main__options-list-item-ic">
            <div class="was_ic">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M78.9,1084.8v12h12v2h-12a1.816,1.816,0,0,1-1.4-.6,1.974,1.974,0,0,1-.6-1.4v-12Zm4-4v2h-2a2.051,2.051,0,0,1,2-2Zm0,4v2h-2v-2Zm0,4v2h-2v-2Zm0,6a1.816,1.816,0,0,1-1.4-.6,1.974,1.974,0,0,1-.6-1.4h2Zm4-14v2h-2v-2Zm0,12v2h-2v-2Zm2-10v-2h2v2Zm0,12v-2h2v2Zm4-14a2.051,2.051,0,0,1,2,2h-2Zm0,6v-2h2v2Zm0,4v-2h2v2Zm0,4v-2h2a2.051,2.051,0,0,1-2,2Z" transform="translate(-76.9 -1080.8)" fill="#fff"/></svg>
            </div>
          </div>
          <div class="main__options-list-item-info">
            <h6>Policies</h6>
            <small>Config access, cache, etc...</small>
          </div>
          <div class="main__options-list-item-arrow"></div>
        </a>
        <a href="<%= request.fullpath %>" class="main__options-list-item clearfix active">
          <div class="main__options-list-item-ic">
            <div class="was_ic">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="12" viewBox="0 0 20 12"><path d="M681.3,1188.2h6v6l-2.3-2.3-6.3,6.3-4-4-6,6-1.4-1.4,7.4-7.4,4,4,4.9-4.9Z" transform="translate(-667.3 -1188.2)" fill="#fff"/></svg>
            </div>
          </div>
          <div class="main__options-list-item-info">
            <h6>Analytic</h6>
            <small>View Analytics of this service</small> 
          </div>
          <div class="main__options-list-item-arrow">
            <div class="arrow_ic">
              <svg xmlns="http://www.w3.org/2000/svg" width="7.4" height="12" viewBox="0 0 7.4 12"><path d="M267.3,398.2l4.6-4.6-4.6-4.6,1.4-1.4,6,6-6,6Z" transform="translate(-267.3 -387.6)" fill="var(--main-color)"/></svg>
            </div>
          </div>
        </a>
        <a href="/cdn/<%= params[:propertyId] %>/<%= params[:dtype] %>/logs?domain=<%= params[:domain] %>" class="main__options-list-item clearfix">
          <div class="main__options-list-item-ic">
            <div class="was_ic">
              <svg xmlns="http://www.w3.org/2000/svg" width="20.9" height="18" viewBox="0 0 20.9 18"><path d="M856.7,1118.2a8.6,8.6,0,0,1,6.4-2.6,9,9,0,0,1,6.4,2.6,8.448,8.448,0,0,1,2.6,6.4,9,9,0,0,1-2.6,6.4,8.448,8.448,0,0,1-6.4,2.6,8.6,8.6,0,0,1-6.3-2.6l1.4-1.5a6.662,6.662,0,0,0,4.9,2.1,7.2,7.2,0,0,0,5-2,6.767,6.767,0,0,0,0-9.8,7.028,7.028,0,0,0-5-2,6.632,6.632,0,0,0-4.9,2,6.8,6.8,0,0,0-2,4.9h3l-4,4-.1-.1-3.9-3.9h3A8.232,8.232,0,0,1,856.7,1118.2Zm5.4,2.4h1.5v4.2l3.5,2.1-.8,1.2-4.3-2.6v-4.9Z" transform="translate(-851.2 -1115.6)"/></svg>
            </div>
          </div>
          <div class="main__options-list-item-info">
            <h6>Logs</h6>
            <small>Download Log files of this service</small>
          </div>
          <div class="main__options-list-item-arrow"></div>
        </a>
      </div>
    </div>
  </div>
</div>
<div class="portal__main-center primary croped">
	<div class="dashboard">
		<div class="dashboard__container">
			<div class="dashboard__container-card clearfix">
        <div class="dashboard__container-card-item">
          <div id="bandwidthUsage" style="width:100%; height:300px;"></div>
          <div class="bandwidthUsageMax p-1 mt-3">
            <div id="bandwidthMaxAvg" style="width:100%; height:150px;"></div>
          </div>
        </div>
        <div class="dashboard__container-card-item">
          <div id="requestOrigin" style="width:100%; height:300px;"></div>
        </div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	function beautifyDateTime(param) {
		return moment(param).format("HH:mm");
	}

	function formatHitRateUnit(param) {
    return param + '%';
  }

  function formatRequest(param) {
    return param;
  }

	function formatVolumeUnit(param) {
    var volumeUnit = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB", "BB", "NB", "DB", "CB", "XB"];
    var i = 0;

    while (param > 1000) {
      param = param / 1000;
      ++i;
    }
    param = (Math.round(param * 100) / 100).toFixed(2) + " " + volumeUnit[i];
    return param;
  }

  function formatBandwidthUnit(param) {
    var unit = ["bps", "Kbps", "Mbps", "Gbps", "Tbps", "Pbps", "Ebps", "Zbps", "Ybps", "Bbps", "Nbps", "Dbps", "Cbps", "Xbps"];

    var i = 0;
    while (param > 1000) {
      param = param / 1000;
      ++i;
    }
    param = (Math.round(param * 100) / 100).toFixed(2) + " " + unit[i];
    return param;
  }

  var bandwidthUsageChart = echarts.init(document.getElementById('bandwidthUsage'));
  var option = {
		tooltip: {
			trigger: 'axis',
      formatter: function (params) {
				let bandwidth = formatVolumeUnit(params[0].data);
				let volume = formatBandwidthUnit(params[1].data);
				return '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#f1f1f1;"></span>Volume: '+bandwidth+'<br/><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:var(--main-color);"></span>Bandwidth: '+volume;
			}
		},
    legend: {
      data:['Bandwidth','Volume']
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: [
      	<% @timestamp.each do |time| %>
      		"<%= time %>",
      	<% end %>
      ],
      axisLabel: {
      	formatter: function (value, index) {
          return beautifyDateTime(value);
        }
      }
    },
    grid: {
    	left: '2%',
      right: '2%',
      bottom: '20px'
    },
    yAxis: {
    	show: false,
    	type: 'value',
      axisLabel: {
      	formatter: function (value, index) {
          return formatBandwidthUnit(value);
        }
      }
    },
    color: [
    	"#e1e1e1","<% if current_user.color.present? %><%= current_user.color %><% else %>#f68100<% end %>"
    ],
    toolbox: {
      show : true,
      feature : {
        saveAsImage : {
        	show: true,
        	title: ' ',
        }
      }
    },
    series: [
    	{
        name:'Volume',
        type:'line',
        itemStyle: {
	      	normal: {
	      		areaStyle: {
	      			type: 'default'
	      		}
	      	}
	      },
        stack: 'Volume',
        data:[
        	<% @trafficValue.each do |value| %>
        		<%= value %>,
        	<% end %>
        ]
      },
    	{
        name:'Bandwidth',
        type:'line',
        stack: 'Bandwidth',
        data:[
        	<% @bandwidthValue.each do |value| %>
        		<%= value %>,
        	<% end %>
        ]
      }
    ]
  };
  bandwidthUsageChart.setOption(option);

  var bandwidthMaxAvgChart = echarts.init(document.getElementById('bandwidthMaxAvg'));
  var option = {
    title: {
      text: 'Max/Average Bandwidth Ratio'
    },
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      },
      formatter: function (params) {
      	let avgBandwidth = formatBandwidthUnit(params[0].data);
				let maxBandwidth = formatBandwidthUnit(params[1].data);
				return '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:var(--main-color);"></span>Max Bandwidth: '+maxBandwidth+'<br/><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#e1e1e1;"></span>Avg Bandwidth: '+avgBandwidth+''
      }
    },
    legend: {
      data: ['Max Bandwidth', 'Avg Bandwidth']
    },
    color: [
    	"<% if current_user.color.present? %><%= current_user.color %><% else %>#f68100<% end %>","#e1e1e1"
    ],
    grid: {
      left: '2%',
      right: '5	%',
      bottom: '20px',
      containLabel: true
    },
    xAxis: {
      type: 'value',
      boundaryGap: [0, 0.01],
      axisLabel: {
      	formatter: function (value, index) {
          return formatBandwidthUnit(value);
        }
      }
    },
    yAxis: {
      type: 'category',
      data: ['Max/Average Bandwidth Ratio']
    },
    series: [
      {
        name: 'Max Bandwidth',
        type: 'bar',
        data: [<%= @maxBandwidth %>]
      },
      {
        name: 'Avg Bandwidth',
        type: 'bar',
        data: [<%= @avgBandwidth %>]
      }
    ]
	};
	bandwidthMaxAvgChart.setOption(option);

  var requestOriginChart = echarts.init(document.getElementById('requestOrigin'));
  var option = {
  	tooltip: {
	  	trigger: 'axis',
	  	formatter: function (params) {
        return formatRequest(params[0].data);
      }
	  },
	  legend: {
      data:['Request Origin']
    },
    grid: {
    	left: '2%',
      right: '2%',
      bottom: '20px'
    },
    xAxis: {
    	type: 'category',
      boundaryGap : false,
      data: [
      	<% @timestamp.each do |time| %>
      		"<%= time %>",
      	<% end %>
      ],
      axisLabel: {
      	formatter: function (value, index) {
          return beautifyDateTime(value);
        }
      }
    },
    yAxis: {
    	show: false,
    	type: 'value',
      axisLabel: {
        formatter: function (value, index) {
          return formatHitRateUnit(value);
        }
      }
    },
    color: [
    	'<% if current_user.color.present? %><%= current_user.color %><% else %>#f68100<% end %>'
    ],
    toolbox: {
      show : true,
      feature : {
        saveAsImage : {
        	show: true,
        	title: ' ',
        }
      }
    },
    series: [{
      name: 'Request Origin',
      type: 'line',
      data:[
      	<% @requestValue.each do |value| %>
      		<%= value %>,
      	<% end %>
      ]
    }]
  };
  requestOriginChart.setOption(option);
</script>